---
interface Props {
  headings: { depth: number; slug: string; text: string }[];
}

const { headings } = Astro.props;

// Filter to only h2 and h3
const toc = headings.filter((h) => h.depth >= 2 && h.depth <= 3);
---

{toc.length > 0 && (
  <aside class="hidden xl:block fixed right-0 top-16 h-[calc(100vh-4rem)] w-64 overflow-y-auto border-l border-[--color-border] bg-[--color-bg-primary]/95 backdrop-blur-xl p-6">
    <!-- Decorative top border -->
    <div class="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-[--color-electron-purple]/30 via-transparent to-transparent"></div>

    <div class="sticky top-6">
      <h4 class="flex items-center gap-2 mb-4 text-xs font-bold uppercase tracking-widest text-[--color-text-tertiary]" style="font-family: var(--font-display);">
        <svg class="w-3.5 h-3.5 text-[--color-electron-purple]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h7"/>
        </svg>
        On this page
      </h4>

      <nav class="relative">
        <!-- Vertical line decoration -->
        <div class="absolute left-0 top-0 bottom-0 w-px bg-gradient-to-b from-[--color-border] via-[--color-border] to-transparent"></div>

        <ul class="space-y-1 pl-4">
          {toc.map((heading, index) => (
            <li style={`animation: fade-in 0.3s ease-out forwards; animation-delay: ${index * 0.05}s; opacity: 0;`}>
              <a
                href={`#${heading.slug}`}
                class:list={[
                  'group block py-1.5 text-sm transition-all duration-200 hover:text-[--color-electron-cyan] relative',
                  heading.depth === 2
                    ? 'text-[--color-text-secondary] font-medium'
                    : 'pl-3 text-[--color-text-tertiary] text-xs',
                ]}
              >
                <!-- Active indicator (shown via JS) -->
                <span class="toc-indicator absolute -left-4 top-1/2 -translate-y-1/2 w-0.5 h-4 bg-[--color-electron-cyan] rounded-full opacity-0 transition-opacity"></span>
                <span class="group-hover:translate-x-1 transition-transform inline-block">{heading.text}</span>
              </a>
            </li>
          ))}
        </ul>
      </nav>

      <!-- Scroll indicator -->
      <div class="mt-8 pt-6 border-t border-[--color-border]">
        <div class="flex items-center gap-2 text-xs text-[--color-text-tertiary]">
          <svg class="w-3 h-3 animate-bounce" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
          </svg>
          <span>Scroll to explore</span>
        </div>
      </div>
    </div>
  </aside>
)}

<style>
  @keyframes fade-in {
    from { opacity: 0; transform: translateX(-5px); }
    to { opacity: 1; transform: translateX(0); }
  }
</style>

<script>
  function initTocHighlight() {
    const headings = document.querySelectorAll('.prose h2, .prose h3');
    const tocLinks = document.querySelectorAll('aside nav a');

    if (headings.length === 0 || tocLinks.length === 0) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const id = entry.target.getAttribute('id');
            tocLinks.forEach((link) => {
              const indicator = link.querySelector('.toc-indicator');
              if (link.getAttribute('href') === `#${id}`) {
                link.classList.add('text-[--color-electron-cyan]');
                if (indicator) indicator.style.opacity = '1';
              } else {
                link.classList.remove('text-[--color-electron-cyan]');
                if (indicator) indicator.style.opacity = '0';
              }
            });
          }
        });
      },
      { rootMargin: '-80px 0px -80% 0px' }
    );

    headings.forEach((heading) => observer.observe(heading));
  }

  initTocHighlight();
  document.addEventListener('astro:after-swap', initTocHighlight);
</script>
